<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
	<head>
			<title>Debug Console</title>
			<meta http-equiv="Content-Language" content="en-us">
			<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
			<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
			<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

			<style>

			.payload {

				margin-left : 50px;
			}

			.requestId {

				text-decoration: underline;
			}

			</style>
	</head>
	<body>
			<script>

				var tagList = [];							// Complete Tag List
				var filteredTagList = [];					// Tag List After Filtered
				var requestIdList = [];

				function htmlEscape(string) { 

					return string.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;");
				}


				function addFilterTag(tag) {

					if (tagList.indexOf(tag) === -1) {

						tagList.push(tag);
						$("#checkboxes").append("<span class='checkboxWrapper'><input type='checkbox' name='tag' class='" + tag + "' value='" + tag + "'>" + tag + "</span><br>");
					}
				}

				// Finds which tags are still shown, and removes unnecessary ones

				function filterTagList() {

					filteredTagList = {};

					$("dd").each(function() {

						
						var hippo = "this should happen"

						if ($(this).css('display') !== 'block') {
							hippo = "this SHOULD NOT HAPPEN";
							return true;
							
						}

						console.log(hippo);

						var tagArray = $(this).attr("class").split(" ");
						/*
						tagArray = $($('.tags')[0]).html().substring(1, $($('.tags')[0]).html().length-1).replace(/\"/g,"").split(",");*/
						
						for (var i = 0, tagArrayLength = tagArray.length; i < tagArrayLength; ++i) {

							filteredTagList[tagArray[i]] = true;		
						}
					})

					for (var i = 0, iLength = tagList.length; i < iLength; ++i) {

						var tag = tagList[i];
						if (filteredTagList[tag]) {
							console.log(tag)
							$('input:checkbox.' + tag).removeAttr("disabled");
						}
						else {
							
							$('input:checkbox.' + tag).attr("disabled", true);
						}
					}
				}


				function wsSend() {

					$('#filterButton').show();
					ws.send($('#session').val());
				}

				function filterRequestId() {

					$("dt").each(function() {

						var requestSelector = this;
						var childrenList = $(requestSelector).children("dd").length;
						var count = 0;

						$(requestSelector).children("dd").each(function() {

							if ($(this).css('display') === 'block') {

								$(requestSelector).show();
							}
							else {

								++count;
							}
						})

						if (childrenList === count) {

							$(requestSelector).hide();
						}
					})
				}


				function filterSome() {

					var checkedLength = $('input:checked').length;


					for(var i = 0; i< checkedLength; ++i) {

						var tag = $('input:checked')[i].value;
						$('.' + tag).removeClass("filtered");
					}
				}


				function filterAll() {

					$("dd").each(function() {

						$(this).removeClass("filtered");
					});
				}


				function checkBoxCount() {

					var checkboxLength = $(':checkbox').length;
					var checkedLength = $('input:checked').length;

					if (checkboxLength === checkedLength) {
					
						filterAll();
					} 
					else if (checkedLength === 0) {
					
						filterAll();
					} 
					else {
					
						filterSome();
					}
				}


				function filter() {

					$("dt").show();
					$("dd").show();

					$("dd").each(function() {

						if (!$(this).hasClass("filtered")) {

							$(this).addClass("filtered");
						}
					});

					checkBoxCount();


					$('.filtered').hide();

					filterRequestId();
					filterTagList();
				}

				// Checks expands/collapse signs

				function checkSigns() {

					$('dt').each(function() {

						var dt = this;
						var done = false;
						var isVisible = false;
						var ddList = $(dt).children("dd");

						for (var i = 0, ddListLength = ddList.length; i < ddListLength; ++i ) {

							if ($(ddList[i]).css("display") === "block") {

								isVisible = true;
							
								var currentSign = $(dt).find(".sign").html();

								if (currentSign === " + ") {
								
									$(dt).find(".sign").html(" - ");
									done = true;
									break;
								}
							}
						}

						if (!done) {

							if (!isVisible) {

								if ($(dt).find(".sign").html() === " - ") {
								
									$(dt).find(".sign").html(" + ");
								}
							}
						}
					})
				}


				var ws = new WebSocket('ws://{{host}}:{{port}}');

				ws.onopen = function() {};


				ws.onmessage = function(message) { 

					var payload = JSON.parse(message.data);
					var tag = payload.tags || ["noTag"];
					var tagString = tag[0].toString();
					var requestId = payload.request;

					addFilterTag(tagString);

					for (var i = 1, iLength = tag.length; i < iLength; ++i) {
						
						addFilterTag(tag[i]);
						tagString += " " + tag[i];
					}

					tagString = "'" + tagString + "'";

					if (requestIdList.indexOf(requestId) === -1) {

						$("#streamList").append("<dt class=" + requestId + "><p class='requestId'>" + "<span class='sign'> - </span>" + requestId + "</p></dt>");
						requestIdList.push(requestId);
					}

					var newPayload = {}
					newPayload.time = new Date(payload.timestamp);
					newPayload.tags = payload.tags;
					newPayload.data = payload.data;



					$("." + requestId).append("<dd class=" + tagString.toString() + "><div class='row'>" + 
						"<div class='span3'>" + JSON.stringify(newPayload.time) + "</div>" +
						"<div class='span2 tags'>" + JSON.stringify(newPayload.tags) + "</div>" +
						"<div class='span3'>" + JSON.stringify(newPayload.data) + "</div>" +
						"</div></dd>");

					filter();
				};


				ws.onclose = function() {};
				

				$(document).ready(function() {

					$('#filterButton').hide();
				
					$(document).on("click", "dt", function() {

						$(this).children("dd").each(function() {

							if ($(this).css("display") === "block") {

								$(this).hide();
							}
							else {

								if (!$(this).hasClass('filtered')) {

									$(this).show();
								}
							}
						})

						checkSigns();
					})

					$(document).on("change", ":checkbox", function(){ 

						filter();
					});
				});
				

			</script>
	       
	        <input id="session" /><button id="subscribe" onclick="wsSend();">Subscribe</button>
	       
	        	<div class-"row" id="columnNames">
	        		<div class="span3">
	        			<p>Time</p>
	        		</div>
	        		<div class="span2">
	        			<p>Tags<p>
	        		</div>
	        		<div class="span3">
	        			<p>Data</p>
	        		</div>
	        		
	        	</div>
	        	<div class="row" id="stream">
		        	<div class="span10">
		        		<dl id=streamList></dl>
		        	</div>
		        	<div class="span4">
		        		<form id="checkboxes"></form>
		        	</div>
	        	</div>
	       
	</body>
</html>