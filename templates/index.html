<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
	<head>
			<title>Debug Console</title>
			<meta http-equiv="Content-Language" content="en-us">
			<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
			<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
			<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

			<style>

			.payload {

				margin-left : 50px;
			}

			.requestId {

				text-decoration: underline;
			}

			</style>
	</head>
	<body>
			<script>

				var tagList = [];
				var requestIdList = [];

				function htmlEscape(string) { 

					return string.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;");
				}


				function addFilterTag(tag) {

					if (tagList.indexOf(tag) === -1) {

						tagList.push(tag);
						$("#checkboxes").append("<input type='checkbox' name='tag' value='" + tag + "'>" + tag + "<br>");
					}
				}


				function wsSend() {

					$('#filterButton').show();
					ws.send($('#session').val());
				}

				function filterRequestId() {

					$("dt").each(function() {

						var requestSelector = this;
						var childrenList = $(requestSelector).children("dd").length;
						var count = 0;

						$(requestSelector).children("dd").each(function() {

							if ($(this).css('display') === 'block') {

								$(requestSelector).show();
							}
							else {

								++count;
							}
						})

						if (childrenList === count) {

							$(requestSelector).hide();
						}
					})
				}

				function filterSome() {

					var checkedLength = $('input:checked').length;


					for(var i = 0; i< checkedLength; ++i) {

						var tag = $('input:checked')[i].value;
						$('.' + tag).removeClass("filtered");
					}

				}

				function filterAll() {

					$("dd").each(function() {

						$(this).removeClass("filtered");
					});
				}

				function checkBoxCount() {

					var checkboxLength = $(':checkbox').length;
					var checkedLength = $('input:checked').length;

					if (checkboxLength === checkedLength) {
						console.log("filteringall")
						filterAll();
					} else if (checkedLength === 0) {
						console.log("filteringall 0")
						filterAll();
					} else {
						console.log("filteringsome")
						filterSome();
					}

				}

				function filter() {

					$("dt").show();
					$("dd").show();

					$("dd").each(function() {

						if (!$(this).hasClass("filtered")) {

							$(this).addClass("filtered");
						}
					});

					checkBoxCount();


					$('.filtered').hide();

					filterRequestId();
				}


				var ws = new WebSocket('ws://{{host}}:{{port}}');

				ws.onopen = function() {};


				ws.onmessage = function(message) { 

					var payload = JSON.parse(message.data);
					var tag = payload.tags || ["noTag"];
					var tagString = tag[0].toString();
					var requestId = payload.request;

					addFilterTag(tagString);

					for (var i = 1, iLength = tag.length; i < iLength; ++i) {
						
						addFilterTag(tag[i]);
						tagString += " " + tag[i];
					}

					tagString = "'" + tagString + "'";

					if (requestIdList.indexOf(requestId) === -1) {

						$("#streamList").append("<dt class=" + requestId + "><p class='requestId'>" + " + " + requestId + "</p></dt>");
						requestIdList.push(requestId);
					}

					$("." + requestId).append("<dd class=" + tagString.toString() + "><p class='payload'>" + htmlEscape(message.data) + "</p1></dd>");

					filter();
				};


				ws.onclose = function() {};

				

				

				$(document).ready(function() {

					$('#filterButton').hide();
				
					$(document).on("click", "dt", function() {

						$(this).children("dd").each(function() {

							if ($(this).css("display") === "block") {

								$(this).hide();
							}

							else {

								if (!$(this).hasClass('filtered')) {

									$(this).show();
								}
							}
						})
					})
				});

			</script>
	       
	        <input id="session" /><button id="subscribe" onclick="wsSend();">Subscribe</button>
	        <pre>
	        	<div class="row" id="stream">
		        	<div class="span4">
		        		<dl id=streamList></dl>
		        	</div>
		        	<div class="span4">
		        		<form id="checkboxes"><input id="filterButton" type="button" value="Filter" onclick="filter();"><br></form>
		        	</div>
	        	</div>
	        </pre>
	</body>
</html>